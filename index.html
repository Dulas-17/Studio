<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BayWatch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
/* Home Section Styles */
.featured-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin: 2rem 0;
}

.featured-item {
  background: #1f1f1f;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #4a6fa5;
  transition: transform 0.3s, box-shadow 0.3s;
}

.featured-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(90, 155, 216, 0.3);
}

.featured-item img {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.featured-content {
  padding: 1rem;
}

.news-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

.news-item {
  background: #1f1f1f;
  border-radius: 12px;
  padding: 1rem;
  border: 1px solid #4a6fa5;
  transition: transform 0.3s;
}

.news-item:hover {
  transform: translateY(-3px);
}

.news-item img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.news-date {
  color: #5a9bd8;
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.news-type {
  display: inline-block;
  background: #5a9bd8;
  color: #121212;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  margin-bottom: 0.5rem;
  font-weight: bold;
}

@media (max-width: 768px) {
  .featured-container {
    grid-template-columns: 1fr;
  }
  
  .news-grid {
    grid-template-columns: 1fr;
  }
}
/* Blue-themed version */
* {
  box-sizing: border-box;
}

html {
  font-size: 16px;
}

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #121212;
  color: #e5f5ff;
  line-height: 1.6;
  touch-action: manipulation;
}

nav {
  background: #1c1c1c;
  padding: 1rem;
  display: flex;
  justify-content: center;
  gap: 1rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
  flex-wrap: wrap;
  width: 100vw;
}

nav button {
  padding: 0.8rem 1.4rem;
  background: #2b3c57;
  color: #d6ecff;
  border: 1px solid #4a6fa5;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}

nav button:hover {
  background: #5a9bd8;
  color: #fff;
  transform: scale(1.05);
  box-shadow: 0 0 8px #5a9bd8;
}

.section {
  display: none;
  padding: 1rem;
  max-width: 1100px;
  margin: auto;
  background: #1a1a1a;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(90, 155, 216, 0.15);
}

.active {
  display: block;
}

.search-container { /* New wrapper for search input + button + suggestions */
  margin: 2rem auto 0.5rem auto;
  width: 90%;
  max-width: 500px;
  position: relative;
  z-index: 10; /* Ensure search-related elements are on top */
}

.search-box { /* Now specifically for the input and button */
  display: flex;
  width: 100%;
}

.search-box input {
  flex-grow: 1; /* Allows input to take up available space */
  padding: 1rem 1rem 1rem 2.8rem; /* Increased left padding for icon */
  font-size: 1rem;
  border-radius: 8px 0 0 8px; /* Rounded left corners, sharp right */
  border: 2px solid #4a6fa5;
  background: #121212;
  color: #d6ecff;
  transition: all 0.3s ease;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23d6ecff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
  background-repeat: no-repeat;
  background-position: 15px center;
  background-size: 20px;
}

.search-box input:focus {
  outline: none;
  border-color: #5a9bd8;
  background: #1c1c1c;
  box-shadow: 0 0 10px rgba(90, 155, 216, 0.5);
}

.search-button {
  padding: 0.8rem 1.2rem;
  background: #5a9bd8;
  color: #121212;
  border: 2px solid #5a9bd8;
  border-radius: 0 8px 8px 0; /* Rounded right corners, sharp left */
  font-weight: bold;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
  white-space: nowrap; /* Prevent button text from wrapping */
}

.search-button:hover {
  background: #81b6ec;
  border-color: #81b6ec;
  transform: translateY(-2px);
  box-shadow: 0 0 8px #5a9bd8;
}

/* Styles for the suggestions container */
.suggestions-container {
  position: absolute;
  top: 100%; /* Position right below the input */
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: #1c1c1c; /* Same as nav for consistency */
  border: 1px solid #4a6fa5;
  border-top: none; /* No top border, blends with input */
  border-radius: 0 0 8px 8px; /* Rounded corners only at the bottom */
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
  z-index: 9; /* Below the input, but above other content */
  display: none; /* Hidden by default */
}

.suggestions-container.active {
  display: block; /* Show when active */
}

.suggestion-item {
  padding: 0.8rem 1rem;
  font-size: 0.95rem;
  color: #d6ecff;
  cursor: pointer;
  border-bottom: 1px solid #2b3c57; /* Separator for items */
}

.suggestion-item:last-child {
  border-bottom: none; /* No border for the last item */
}

.suggestion-item:hover,
.suggestion-item.highlighted { /* Optional: for keyboard navigation */
  background: #2b3c57;
  color: #fff;
}

.genre-buttons {
  margin: 1.5rem 0;
  text-align: center;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.7rem;
}

.genre-buttons button {
  padding: 0.6rem 1.2rem;
  background: #2b3c57;
  color: #d6ecff;
  border: 1px solid #4a6fa5;
  border-radius: 25px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
}

.genre-buttons button:hover {
  background: #5a9bd8;
  color: #fff;
  transform: scale(1.03);
  box-shadow: 0 0 10px #5a9bd8;
}

.genre-buttons button.active-genre {
  background: #5a9bd8;
  color: #fff;
  border-color: #d6ecff;
  box-shadow: 0 0 15px #5a9bd8;
  transform: scale(1.05);
}

.series-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
}

.series-item {
  background: #1f1f1f;
  padding: 0.5rem;
  border-radius: 10px;
  text-align: center;
  border: 1px solid #4a6fa5;
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
}

.series-item:hover {
  background: #2b3c57;
  transform: scale(1.09);
  box-shadow: 0 0 10px rgba(90, 155, 216, 0.5);
}

.series-item img {
  width: 100%;
  height: auto;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

.series-details {
  text-align: center;
  margin-top: 1rem;
}

.series-details img {
  width: 100%;
  max-height: 500px;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

.episode-buttons {
  margin-top: 1rem;
}

.episode-buttons button {
  display: block;
  width: 100%;
  margin: 0.5rem auto;
  padding: 1.3rem;
  background: #2d486a;
  color: #d6ecff;
  border: 1px solid #5a9bd8;
  border-radius: 8px;
  font-size: 2.5rem;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
}

.episode-buttons button:hover {
  background: #5a9bd8;
  color: #fff;
  transform: scale(1.05);
  box-shadow: 0 0 10px #5a9bd8;
}

#videoFullScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #000;
  z-index: 9999;
  display: none;
  flex-direction: column;
}

#videoFullScreen iframe {
  flex: 1;
  width: 100%;
  height: 100%;
  border: none;
}

#videoFullScreen button {
  padding: 0.5rem;
  background: #dc2626;
  color: white;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  width: 50px;
  border-radius: 5px;
  transition: background 0.3s;
}

#videoFullScreen button:hover {
  background: #f87171;
}

.resume-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 0.3rem 0.6rem;
  border-radius: 4px;
  font-size: 0.8rem;
  z-index: 1;
}

@media (min-width: 481px) {
  .series-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (min-width: 768px) {
  .series-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  nav {
    justify-content: flex-start;
    padding: 0.8rem;
  }
  nav button {
    margin-right: 0.5rem;
  }
  .h4 {
    font-size: 1.3rem;
  }
}

@media (min-width: 1200px) {
  .series-grid {
    grid-template-columns: repeat(5, 1fr);
  }
}

@media (max-width: 480px) {
  html {
    font-size: 12px;
  }
  .series-item {
    padding: 0.3rem;
  }
  .episode-buttons button {
    padding: 0.8rem;
    font-size: 0.9rem;
  }
  .h4 {
    font-size: 1rem;
  }
  .genre-buttons {
    gap: 0.5rem;
  }
  .genre-buttons button {
    padding: 0.5rem 0.8rem;
    font-size: 0.8rem;
  }
  /* Adjust search button for smaller screens */
  .search-button {
    padding: 0.8rem; /* Smaller padding */
    font-size: 0.9rem;
  }
  .search-box input {
    padding-left: 2.2rem; /* Adjust padding for icon */
    background-position: 10px center; /* Adjust icon position */
  }
}

.btn {
  padding: 0.4rem;
  font-size: 0.8rem;
  font-weight: bold;
  border-radius: 10px;
  background: #5a9bd8;
  color: #000;
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
}

.btn:hover {
  background: #81b6ec;
  color: #000;
  transform: translateY(-2px);
  box-shadow: 0 0 8px #5a9bd8;
}

.back {
  padding: 1rem 1.8rem;
  font-size: 1rem;
  font-weight: bold;
  border-radius: 10px;
  background: red;
  color: black;
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
}

.back:hover {
  background: #81b6ec;
  color: #000;
  transform: translateY(-3px);
  box-shadow: 0 0 8px #5a9bd8;
}

.watch-later-btn {
  padding: 0.4rem;
  font-size: 0.8rem;
  font-weight: bold;
  border-radius: 10px;
  background: #f39c12;
  color: #fff;
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
  margin-top: 0.5rem;
}

.watch-later-btn:hover {
  background: #e67e22;
  transform: translateY(-2px);
  box-shadow: 0 0 8px #f39c12;
}

.remove-watch-later-btn {
  padding: 0.4rem;
  font-size: 0.8rem;
  font-weight: bold;
  border-radius: 10px;
  background: #e74c3c;
  color: #fff;
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
  margin-top: 0.5rem;
}

.remove-watch-later-btn:hover {
  background: #c0392b;
  transform: translateY(-2px);
  box-shadow: 0 0 8px #e74c3c;
}
</style>
</head>
<body>

  <nav>
    <button onclick="showSection('home')">Home</button>
    <button onclick="showSection('movies')">Movies</button>
    <button onclick="showSection('series')">Series</button>
    <button onclick="showWatchLater()">Watch Later</button>
  </nav>

  <div id="home" class="section">
  <h1>Baywatch</h1>
  <div class="search-container">
    <div class="search-box">
      <input type="text" id="homeSearch" placeholder="Search news...">
      <button class="search-button" onclick="searchContent('home')">Search</button>
    </div>
    <div id="homeSuggestions" class="suggestions-container"></div>
  </div>
  <div id="featuredContent" class="featured-container"></div>
  <div id="newsFeed" class="news-grid"></div>
</div>

  <div id="series" class="section">
    <h2>Shows</h2>
    <div class="search-container"> <div class="search-box">
            <input type="text" id="seriesSearch" placeholder="Search for a series...">
            <button class="search-button" onclick="searchContent('series')">Search</button>
        </div>
        <div id="seriesSuggestions" class="suggestions-container"></div>
    </div>
    <div class="genre-buttons" id="seriesGenreButtons"></div>
    <div id="seriesList" class="series-grid"></div>
    <div id="seriesDetails" class="series-details" style="display: none;"></div>
  </div>

  <div id="movies" class="section">
    <h2>Movies</h2>
    <div class="search-container"> <div class="search-box">
            <input type="text" id="movieSearch" placeholder="Search for a movie...">
            <button class="search-button" onclick="searchContent('movies')">Search</button>
        </div>
        <div id="movieSuggestions" class="suggestions-container"></div>
    </div>
    <div class="genre-buttons" id="movieGenreButtons"></div>
    <div id="movieList" class="series-grid"></div>
    <div id="movieDetails" class="series-details" style="display: none;"></div>
  </div>

  <div id="watchLater" class="section">
    <h2>Your Watch Later List</h2>
    <div id="watchLaterList" class="series-grid"></div>
  </div>

  <div id="videoFullScreen">
    <button onclick="closeFullScreen()">ðŸ”™</button>
    <iframe src="" allowfullscreen></iframe>
  </div>
<script src="106.js"></script>
<script src="11.js"></script>
<script src="12.js"></script>
<script>
// Ensure seriesData and movieData are loaded before this script runs.
const content = {
  series: seriesData, // From 11.js
  movies: movieData,  // From 12.js
  home: homeData      // From 10.js
};

// Global variables for debouncing
let searchDebounceTimeout;
let suggestionDebounceTimeout;

// --- Video Position Tracking ---
function saveVideoPosition(videoId, currentTime, duration) {
    const videoProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
    videoProgress[videoId] = {
        currentTime: currentTime,
        duration: duration,
        timestamp: Date.now()
    };
    localStorage.setItem('videoProgress', JSON.stringify(videoProgress));
}

function getVideoPosition(videoId) {
    const videoProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
    return videoProgress[videoId] || null;
}

function clearVideoPosition(videoId) {
    const videoProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
    delete videoProgress[videoId];
    localStorage.setItem('videoProgress', JSON.stringify(videoProgress));
}

function playEpisode(link, episodeTitle = null) {
    const player = document.getElementById('videoFullScreen');
    const iframe = player.querySelector('iframe');
    const videoId = episodeTitle ? `${link}-${episodeTitle}` : link;
    const savedPosition = getVideoPosition(videoId);
    const startTime = savedPosition ? savedPosition.currentTime : 0;

    let videoUrl = link;
    if (startTime > 0) {
        const separator = link.includes('?') ? '&' : '?';
        videoUrl = `${link}${separator}t=${Math.floor(startTime)}`;
    }

    iframe.src = videoUrl;
    player.style.display = 'flex';

    window.addEventListener('message', function videoProgressListener(event) {
        if (event.source !== iframe.contentWindow) return;
        try {
            const data = JSON.parse(event.data);
            if (data.currentTime && data.duration) {
                saveVideoPosition(videoId, data.currentTime, data.duration);
            }
        } catch (e) {
            console.log('Received non-progress message from iframe');
        }
    });

    iframe._progressListener = videoProgressListener;
}

function closeFullScreen() {
    const player = document.getElementById('videoFullScreen');
    const iframe = player.querySelector('iframe');

    if (iframe._progressListener) {
        window.removeEventListener('message', iframe._progressListener);
        delete iframe._progressListener;
    }

    iframe.src = '';
    player.style.display = 'none';
    restoreScrollPosition();
}

// --- Local Storage Utilities ---
function saveScrollPosition() {
    localStorage.setItem('scrollPosition', window.scrollY);
}

function restoreScrollPosition() {
    const storedScrollY = localStorage.getItem('scrollPosition');
    if (storedScrollY) {
        window.scrollTo(0, parseInt(storedScrollY, 10));
    }
}

function saveState(sectionId, detailType = null, detailIndex = null, originSection = null) {
    console.log(`saveState called: sectionId=${sectionId}, detailType=${detailType}, detailIndex=${detailIndex}, originSection=${originSection}`);
    localStorage.setItem('lastActiveSection', sectionId);

    if (detailType !== null && detailIndex !== null) {
        localStorage.setItem('lastDetailType', detailType);
        localStorage.setItem('lastDetailIndex', detailIndex);
    } else {
        localStorage.removeItem('lastDetailType');
        localStorage.removeItem('lastDetailIndex');
    }

    localStorage.removeItem('activeGenre');

    if (originSection !== null) {
        localStorage.setItem('originSection', originSection);
    } else {
        localStorage.removeItem('originSection');
    }
    saveScrollPosition();
}

// --- Home Section Functions ---
function renderHomeContent() {
    renderFeaturedContent();
    renderNewsFeed();
}

function renderFeaturedContent() {
    const container = document.getElementById('featuredContent');
    if (!container) return;
    
    container.innerHTML = '';
    
    content.home.featuredContent.forEach(item => {
        const contentItem = item.type === 'movie' ? content.movies[item.id] : content.series[item.id];
        if (!contentItem) return;
        
        const div = document.createElement('div');
        div.className = 'featured-item';
        div.innerHTML = `
            <img src="${contentItem.image}" alt="${contentItem.title}">
            <div class="featured-content">
                <h3>${item.title}</h3>
                <h4>${contentItem.title}</h4>
                <button onclick="${item.type === 'movie' ? `showMovieDetails(${item.id})` : `showSeriesDetails(${item.id})`}" class="btn">
                    View ${item.type === 'movie' ? 'Movie' : 'Series'}
                </button>
            </div>
        `;
        container.appendChild(div);
    });
}

function renderNewsFeed(filteredItems = null) {
    const container = document.getElementById('newsFeed');
    if (!container) return;
    
    container.innerHTML = '';
    
    const itemsToRender = filteredItems || content.home.newsFeed;
    
    if (itemsToRender.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #aaa;">No news items found.</p>';
        return;
    }
    
    itemsToRender.forEach(item => {
        const div = document.createElement('div');
        div.className = 'news-item';
        div.innerHTML = `
            <span class="news-type">${item.type.toUpperCase()}</span>
            <span class="news-date">${item.date}</span>
            ${item.image ? `<img src="${item.image}" alt="${item.title}">` : ''}
            <h3>${item.title}</h3>
            <p>${item.content}</p>
        `;
        container.appendChild(div);
    });
}

function searchHomeContent(query) {
    const filtered = content.home.newsFeed.filter(item => 
        item.title.toLowerCase().includes(query) || 
        item.content.toLowerCase().includes(query) ||
        item.type.toLowerCase().includes(query)
    );
    renderNewsFeed(filtered);
}

// --- Section Management ---
function showSection(id) {
    console.log(`showSection called for: ${id}`);
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    saveState(id); 

    document.getElementById('seriesDetails').style.display = 'none';
    document.getElementById('movieDetails').style.display = 'none';
    document.querySelector('nav').style.display = 'flex'; 

    document.querySelectorAll('.search-container').forEach(sc => sc.style.display = 'none');
    document.querySelectorAll('.genre-buttons').forEach(gb => gb.style.display = 'none');

    if (document.getElementById('seriesSearch')) {
        document.getElementById('seriesSearch').value = '';
        hideSuggestions('series');
    }
    if (document.getElementById('movieSearch')) {
        document.getElementById('movieSearch').value = '';
        hideSuggestions('movies');
    }
    if (document.getElementById('homeSearch')) {
        document.getElementById('homeSearch').value = '';
        hideSuggestions('home');
    }

    if (id === 'home') {
        document.querySelector('#home .search-container').style.display = 'block';
        renderHomeContent();
    } else if (id === 'series') {
        document.querySelector('#series .search-container').style.display = 'block';
        document.getElementById('seriesGenreButtons').style.display = 'flex';
        const activeGenreSeries = localStorage.getItem('activeGenre_series') || 'All';
        console.log(`Series section active. Stored genre: ${activeGenreSeries}`);
        renderGenreButtons('series');
        filterContentByGenre('series', activeGenreSeries); 
    } else if (id === 'movies') {
        document.querySelector('#movies .search-container').style.display = 'block';
        document.getElementById('movieGenreButtons').style.display = 'flex';
        const activeGenreMovies = localStorage.getItem('activeGenre_movies') || 'All';
        console.log(`Movies section active. Stored genre: ${activeGenreMovies}`);
        renderGenreButtons('movies');
        filterContentByGenre('movies', activeGenreMovies); 
    } else if (id === 'watchLater') {
        showWatchLater();
    }
    window.scrollTo(0, 0);
}

// --- Search Functionality ---
function performSearch(type) {
    if (type === 'home') {
        const inputElement = document.getElementById('homeSearch');
        const query = inputElement.value.toLowerCase().trim();
        searchHomeContent(query);
        return;
    }

    const inputElement = document.getElementById(type === 'series' ? 'seriesSearch' : 'movieSearch');
    const query = inputElement.value.toLowerCase().trim();
    console.log(`Performing search for ${type} with query: "${query}"`);

    hideSuggestions(type);

    const filtered = content[type].filter(item => {
        if (item.title.toLowerCase().includes(query)) return true;
        if (item.description && item.description.toLowerCase().includes(query)) return true;
        if (item.genres && item.genres.some(genre => genre.toLowerCase().includes(query))) return true;
        return false;
    });

    localStorage.setItem(`activeGenre_${type}`, 'All');
    console.log(`Search performed, activeGenre_${type} set to 'All'.`);
    renderGenreButtons(type); 

    const listContainer = document.getElementById(type === 'series' ? 'seriesList' : 'movieList');
    if (filtered.length === 0 && query !== '') {
        listContainer.innerHTML = `<p style="text-align: center; color: #aaa; margin-top: 2rem;">No results found for "${query}".</p>`;
    } else {
        if (type === 'series') {
            showSeriesList(filtered, query);
        } else {
            showMovieList(filtered, query);
        }
    }
    saveScrollPosition();
}

function searchContent(type) {
    clearTimeout(searchDebounceTimeout);
    clearTimeout(suggestionDebounceTimeout);
    performSearch(type);
}

function handleSearchInputForSuggestions(type) {
    const inputElement = document.getElementById(type === 'series' ? 'seriesSearch' : type === 'movies' ? 'movieSearch' : 'homeSearch');
    const query = inputElement.value.toLowerCase().trim();

    clearTimeout(suggestionDebounceTimeout);
    if (query.length > 0) {
        suggestionDebounceTimeout = setTimeout(() => {
            showSuggestions(type, query);
        }, 100);
    } else {
        hideSuggestions(type);
    }
}

// --- Search Suggestions ---
function showSuggestions(type, query) {
    if (type === 'home') {
        hideSuggestions(type);
        return;
    }

    const suggestionsContainer = document.getElementById(type === 'series' ? 'seriesSuggestions' : 'movieSuggestions');
    suggestionsContainer.innerHTML = '';

    if (query.length === 0) {
        hideSuggestions(type);
        return;
    }

    const relevantContent = content[type];
    const matchingSuggestions = relevantContent.filter(item =>
        item.title.toLowerCase().includes(query)
    ).slice(0, 5);

    if (matchingSuggestions.length > 0) {
        matchingSuggestions.forEach(item => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item';
            const highlightedText = item.title.replace(new RegExp(query, 'gi'), match => `<span style="background-color: #5a9bd8; color: #121212; border-radius: 3px; padding: 0 2px;">${match}</span>`);
            suggestionItem.innerHTML = highlightedText;
            suggestionItem.onclick = () => selectSuggestion(type, item.title);
            suggestionsContainer.appendChild(suggestionItem);
        });
        suggestionsContainer.classList.add('active');
    } else {
        hideSuggestions(type);
    }
}

function selectSuggestion(type, title) {
    const inputElement = document.getElementById(type === 'series' ? 'seriesSearch' : 'movieSearch');
    inputElement.value = title;
    hideSuggestions(type);
    performSearch(type);
}

function hideSuggestions(type) {
    const suggestionsContainer = document.getElementById(type === 'series' ? 'seriesSuggestions' : type === 'movies' ? 'movieSuggestions' : 'homeSuggestions');
    suggestionsContainer?.classList.remove('active');
}

// --- Genre Filtering ---
function getUniqueGenres(type) {
    const allGenres = content[type].flatMap(item => item.genres || []);
    return ['All', ...new Set(allGenres)].sort();
}

function renderGenreButtons(type) {
    const containerId = type === 'series' ? 'seriesGenreButtons' : 'movieGenreButtons';
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';
    const genres = getUniqueGenres(type);
    const activeGenre = localStorage.getItem(`activeGenre_${type}`) || 'All';
    console.log(`Rendering genre buttons for ${type}. Active genre from storage: ${activeGenre}`);

    genres.forEach(genre => {
        const button = document.createElement('button');
        button.textContent = genre;
        button.onclick = () => filterContentByGenre(type, genre);
        if (genre === activeGenre) {
            button.classList.add('active-genre');
        }
        container.appendChild(button);
    });
}

function filterContentByGenre(type, genre) { 
    console.log(`filterContentByGenre called for ${type} with genre: ${genre}`);
    const genreButtonsContainerId = type === 'series' ? 'seriesGenreButtons' : 'movieGenreButtons';
    const buttons = document.getElementById(genreButtonsContainerId).querySelectorAll('button');

    buttons.forEach(button => {
        button.classList.toggle('active-genre', button.textContent === genre);
    });

    let filteredList;
    if (genre === 'All') {
        filteredList = content[type];
    } else {
        filteredList = content[type].filter(item => item.genres && item.genres.includes(genre));
    }

    if (type === 'series') {
        document.getElementById('seriesSearch').value = '';
        hideSuggestions('series');
    } else if (type === 'movies') {
        document.getElementById('movieSearch').value = '';
        hideSuggestions('movies');
    }

    if (type === 'series') {
        showSeriesList(filteredList);
    } else {
        showMovieList(filteredList);
    }

    localStorage.setItem(`activeGenre_${type}`, genre);
    console.log(`activeGenre_${type} saved as: ${genre}`);
    window.scrollTo(0, 0);
}

// --- Display List Functions ---
function showSeriesList(list = null, query = '') {
    const currentList = list || content.series;
    const container = document.getElementById('seriesList');
    container.innerHTML = '';

    const activeGenre = localStorage.getItem('activeGenre_series');
    console.log(`showSeriesList called. Active series genre: ${activeGenre}. Query: "${query}"`);

    const displayList = (list === null && activeGenre && activeGenre !== 'All')
        ? currentList.filter(s => s.genres && s.genres.includes(activeGenre))
        : currentList;

    if (displayList.length === 0 && query !== '') {
        container.innerHTML = `<p style="text-align: center; color: #aaa; margin-top: 2rem;">No results found for "${query}".</p>`;
        return;
    } else if (displayList.length === 0 && (list === null || query === '')) {
        container.innerHTML = `<p style="text-align: center; color: #aaa; margin-top: 2rem;">No items to display here.</p>`;
        return;
    }

    displayList.forEach((s) => {
        const div = document.createElement('div');
        div.className = 'series-item';
        const originalIndex = content.series.indexOf(s);
        if (originalIndex === -1) return;

        const hasProgress = s.episodes && s.episodes.some(ep => {
            const videoId = `${ep.link}-${ep.title}`;
            return getVideoPosition(videoId);
        });

        const highlightedTitle = query ? s.title.replace(new RegExp(query, 'gi'), match => `<span style="background-color: #5a9bd8; color: #121212; border-radius: 3px; padding: 0 2px;">${match}</span>`) : s.title;

        div.innerHTML = `
          <img src="${s.image}" alt="${s.title}" />
          <h4>${highlightedTitle}</h4>
          ${hasProgress ? '<div class="resume-badge">Continue Watching</div>' : ''}
          <button onclick="showSeriesDetails(${originalIndex})" class="btn">Open</button>
          <button onclick="addToWatchLater('series', ${originalIndex})" class="watch-later-btn">Watch Later</button>
        `;
        container.appendChild(div);
    });

    if (list === null && localStorage.getItem('lastActiveSection') === 'series' && !localStorage.getItem('lastDetailType')) {
        restoreScrollPosition();
    }
}

function showMovieList(list = null, query = '') {
    const currentList = list || content.movies;
    const container = document.getElementById('movieList');
    container.innerHTML = '';

    const activeGenre = localStorage.getItem('activeGenre_movies');
    console.log(`showMovieList called. Active movie genre: ${activeGenre}. Query: "${query}"`);

    const displayList = (list === null && activeGenre && activeGenre !== 'All')
        ? currentList.filter(m => m.genres && m.genres.includes(activeGenre))
        : currentList;

    if (displayList.length === 0 && query !== '') {
        container.innerHTML = `<p style="text-align: center; color: #aaa; margin-top: 2rem; justify-content:center; font-size:1.5rem;">No results found for "${query}".</p>`;
        return;
    } else if (displayList.length === 0 && (list === null || query === '')) {
        container.innerHTML = `<p style="text-align: center; color: #aaa; margin-top: 2rem;">No items to display here.</p>`;
        return;
    }

    displayList.forEach((m) => {
        const div = document.createElement('div');
        div.className = 'series-item';
        const originalIndex = content.movies.indexOf(m);
        if (originalIndex === -1) return;

        const videoId = m.link;
        const hasProgress = getVideoPosition(videoId);

        const highlightedTitle = query ? m.title.replace(new RegExp(query, 'gi'), match => `<span style="background-color: #5a9bd8; color: #121212; border-radius: 3px; padding: 0 2px;">${match}</span>`) : m.title;

        div.innerHTML = `
          <img src="${m.image}" alt="${m.title}" />
          <h4>${highlightedTitle}</h4>
          ${hasProgress ? '<div class="resume-badge">Continue Watching</div>' : ''}
          <button onclick="showMovieDetails(${originalIndex})" class="btn">Open</button>
          <button onclick="addToWatchLater('movie', ${originalIndex})" class="watch-later-btn">Watch Later</button>
        `;
        container.appendChild(div);
    });

    if (list === null && localStorage.getItem('lastActiveSection') === 'movies' && !localStorage.getItem('lastDetailType')) {
        restoreScrollPosition();
    }
}

// --- Share Functionality ---
function generateShareLink(type, index) {
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}?type=${type}&id=${index}`;
}

async function shareContent(type, index) {
    const item = type === 'series' ? content.series[index] : content.movies[index];
    if (!item) {
        console.error('Item not found for sharing:', type, index);
        alert('Could not find item to share.');
        return;
    }

    const shareUrl = generateShareLink(type, index);
    const shareData = {
        title: `Stream ${item.title} on BayWatch!`,
        text: item.description ? `"${item.description}"` : '',
        url: shareUrl,
    };

    console.log("Attempting to share:", shareData);

    try {
        if (navigator.share) {
            await navigator.share(shareData);
            console.log('Content shared successfully via Web Share API!');
        } else {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareData.title + '\n' + shareData.text + '\n' + shareData.url)}`;
            window.open(whatsappUrl, '_blank');
            console.log('Opened WhatsApp for sharing.');
        }
    } catch (error) {
        console.error('Error sharing content:', error);
        if (error.name !== 'AbortError') { 
            alert('Failed to share. Please try again or copy the link directly.');
        }
    }
}

function copyLinkToClipboard(type, index) {
    const shareUrl = generateShareLink(type, index);
    navigator.clipboard.writeText(shareUrl)
        .then(() => {
            alert('Link copied to clipboard!');
            console.log('Link copied:', shareUrl);
        })
        .catch(err => {
            console.error('Failed to copy link:', err);
            alert('Failed to copy link. Please try again.');
        });
}

// --- Detail View Functions ---
function showSeriesDetails(i, originSection = null) {
    console.log(`showSeriesDetails called for index: ${i}, origin: ${originSection}`);
    const s = content.series[i];
    if (!s) {
        console.error("Error: Series item not found at index:", i);
        alert("Could not load series details. Data might be missing or corrupted.");
        showSection(originSection === 'watchLater' ? 'watchLater' : 'series');
        return;
    }
    const container = document.getElementById('seriesDetails');

    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('series').classList.add('active');

    document.getElementById('seriesList').innerHTML = '';
    document.getElementById('seriesDetails').style.display = 'block';

    document.querySelector('nav').style.display = 'none'; 
    document.querySelectorAll('.search-container').forEach(sc => sc.style.display = 'none');
    document.querySelectorAll('.genre-buttons').forEach(gb => gb.style.display = 'none');

    container.innerHTML = `
        <img src="${s.image}" alt="${s.title}" />
        <h2>${s.title}</h2>
        <p>${s.description}</p>
        <div class="episode-buttons">
          ${s.episodes.map(ep => {
              const videoId = `${ep.link}-${ep.title}`;
              const progress = getVideoPosition(videoId);
              const progressText = progress ? ` (${formatTime(progress.currentTime)}/${formatTime(progress.duration)})` : '';
              return `<button onclick="playEpisode('${ep.link}', '${ep.title.replace(/'/g, "\\'")}')">${ep.title}${progressText}</button>`;
          }).join('')}
        </div>
        <div class="detail-bottom-actions"> 
            <button onclick="shareContent('series', ${i})" class="btn share-btn">Share</button>
            <button onclick="goBackToList('series')" class="back">Back</button>
            <button onclick="copyLinkToClipboard('series', ${i})" class="btn copy-link-btn">Copy Link</button>
        </div>
      `;

    saveState('series', 'series', i, originSection);
    window.scrollTo(0, 0);
}

function showMovieDetails(i, originSection = null) {
    console.log(`showMovieDetails called for index: ${i}, origin: ${originSection}`);
    const m = content.movies[i];
    if (!m) {
        console.error("Error: Movie item not found at index:", i);
        alert("Could not load movie details. Data might be missing or corrupted.");
        showSection(originSection === 'watchLater' ? 'watchLater' : 'movies');
        return;
    }
    const container = document.getElementById('movieDetails');

    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('movies').classList.add('active');

    document.getElementById('movieList').innerHTML = '';
    document.getElementById('movieDetails').style.display = 'block';

    document.querySelector('nav').style.display = 'none';
    document.querySelectorAll('.search-container').forEach(sc => sc.style.display = 'none');
    document.querySelectorAll('.genre-buttons').forEach(gb => gb.style.display = 'none');

    const videoId = m.link;
    const progress = getVideoPosition(videoId);
    const progressText = progress ? ` (${formatTime(progress.currentTime)}/${formatTime(progress.duration)})` : '';

    container.innerHTML = `
        <img src="${m.image}" alt="${m.title}" />
        <h2>${m.title}</h2>
        <p>${m.description}</p>
        <div class="episode-buttons">
          <button onclick="playEpisode('${m.link}', '${m.title.replace(/'/g, "\\'")}')">Watch Now${progressText}</button>
        </div>
        <div class="detail-bottom-actions">  
            <button onclick="goBackToList('movies')" class="back">Back</button>
            <button onclick="shareContent('movie', ${i})" class="btn share-btn">Share</button>
            <button onclick="copyLinkToClipboard('movie', ${i})" class="btn copy-link-btn">Copy Link</button>
        </div>
      `;
    saveState('movies', 'movie', i, originSection);
    window.scrollTo(0, 0);
}

function formatTime(seconds) {
    if (!seconds) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
}

function goBackToList(type) {
    console.log(`goBackToList called for: ${type}`);
    if (type === 'series') {
        document.getElementById('seriesSearch').value = '';
    } else if (type === 'movies') {
        document.getElementById('movieSearch').value = '';
    }

    const originSection = localStorage.getItem('originSection');

    if (type === 'series') {
        document.getElementById('seriesDetails').style.display = 'none';
    } else {
        document.getElementById('movieDetails').style.display = 'none';
    }

    let targetSectionId = originSection === 'watchLater' ? 'watchLater' : type;
    showSection(targetSectionId); 
    window.scrollTo(0, 0);
}

// --- Watch Later Functionality ---
function getWatchLaterList() {
    const watchLaterJson = localStorage.getItem('watchLater');
    return watchLaterJson ? JSON.parse(watchLaterJson) : [];
}

function saveWatchLaterList(list) {
    localStorage.setItem('watchLater', JSON.stringify(list));
}

function addToWatchLater(type, index) {
    const item = type === 'series' ? content.series[index] : content.movies[index];
    const watchLaterList = getWatchLaterList();
    const itemId = `${type}-${index}`;

    const isAlreadyAdded = watchLaterList.some(
        (wlItem) => wlItem.uniqueId === itemId
    );

    if (!isAlreadyAdded) {
        watchLaterList.push({ uniqueId: itemId, type: type, originalIndex: index, itemData: item });
        saveWatchLaterList(watchLaterList);
        alert(`${item.title} added to Watch Later!`);
    } else {
        alert(`${item.title} is already in your Watch Later list.`);
    }
}

function removeFromWatchLater(type, originalIndex) {
    let watchLaterList = getWatchLaterList();
    const initialLength = watchLaterList.length;
    const itemIdToRemove = `${type}-${originalIndex}`;
    watchLaterList = watchLaterList.filter(
        (wlItem) => wlItem.uniqueId !== itemIdToRemove
    );

    if (watchLaterList.length < initialLength) {
        saveWatchLaterList(watchLaterList);
        alert('Item removed from Watch Later!');
        showWatchLater();
    }
}

function showWatchLater() {
    console.log('showWatchLater called');
    document.querySelectorAll('.search-container').forEach(sc => sc.style.display = 'none');
    document.querySelectorAll('.genre-buttons').forEach(gb => gb.style.display = 'none');
    document.querySelector('nav').style.display = 'flex'; 
    document.getElementById('seriesDetails').style.display = 'none';
    document.getElementById('movieDetails').style.display = 'none';

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('watchLater').classList.add('active');

    const container = document.getElementById('watchLaterList');
    container.innerHTML = '';

    const watchLaterItems = getWatchLaterList();

    if (watchLaterItems.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #aaa;">Your Watch Later list is empty. Add some series or movies!</p>';
    } else {
        watchLaterItems.forEach((wlItem) => {
            const item = wlItem.itemData;
            const div = document.createElement('div');
            div.className = 'series-item';

            const detailFunctionCall = wlItem.type === 'series'
                ? `showSeriesDetails(${wlItem.originalIndex}, 'watchLater')`
                : `showMovieDetails(${wlItem.originalIndex}, 'watchLater')`;

            div.innerHTML = `
                <img src="${item.image}" alt="${item.title}" />
                <h4>${item.title}</h4>
                <button onclick="${detailFunctionCall}" class="btn">View Details</button>
                <button onclick="removeFromWatchLater('${wlItem.type}', ${wlItem.originalIndex})" class="remove-watch-later-btn">Remove</button>
            `;
            container.appendChild(div);
        });
    }
    saveState('watchLater');
    window.scrollTo(0, 0);
}

// --- Initialize on DOM Content Loaded ---
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded. Initializing...');

    const urlParams = new URLSearchParams(window.location.search);
    const paramType = urlParams.get('type');
    const paramId = urlParams.get('id');

    if (paramType && paramId !== null) {
        const id = parseInt(paramId, 10);
        if (!isNaN(id)) {
            console.log(`Direct link detected: type=${paramType}, id=${id}`);
            localStorage.removeItem('lastActiveSection');
            localStorage.removeItem('lastDetailType');
            localStorage.removeItem('lastDetailIndex');
            localStorage.removeItem('originSection');

            if (paramType === 'series' && content.series[id]) {
                showSeriesDetails(id);
            } else if (paramType === 'movie' && content.movies[id]) {
                showMovieDetails(id);
            } else {
                console.warn('Direct link item not found or invalid type. Loading home.');
                showSection('home');
            }
        } else {
            console.warn('Invalid ID in direct link. Loading home.');
            showSection('home');
        }
    } else {
        const lastActiveSection = localStorage.getItem('lastActiveSection');
        const lastDetailType = localStorage.getItem('lastDetailType');
        const lastDetailIndex = localStorage.getItem('lastDetailIndex');
        const originSection = localStorage.getItem('originSection');

        if (lastActiveSection) {
            console.log(`Restoring last active section: ${lastActiveSection}`);
            if (lastDetailType && lastDetailIndex !== null) {
                console.log(`Restoring detail view: ${lastDetailType} at index ${lastDetailIndex}`);
                document.querySelector('nav').style.display = 'none';
                document.querySelectorAll('.search-container').forEach(sc => sc.style.display = 'none');
                document.querySelectorAll('.genre-buttons').forEach(gb => gb.style.display = 'none');

                if (lastDetailType === 'series') {
                    showSeriesDetails(parseInt(lastDetailIndex, 10), originSection);
                } else if (lastDetailType === 'movie') {
                    showMovieDetails(parseInt(lastDetailIndex, 10), originSection);
                }
            } else {
                showSection(lastActiveSection);
            }
            restoreScrollPosition();
        } else {
            console.log('No last active section found. Defaulting to "home".');
            showSection('home');
        }
    }

    renderGenreButtons('series');
    renderGenreButtons('movies');

    // Setup search inputs
    const setupSearchInput = (type) => {
        const inputElement = document.getElementById(`${type}Search`);
        if (inputElement) {
            inputElement.addEventListener('input', () => handleSearchInputForSuggestions(type));
            inputElement.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    searchContent(type);
                }
            });
            inputElement.addEventListener('blur', () => setTimeout(() => hideSuggestions(type), 100));
            inputElement.addEventListener('focus', (event) => {
                const query = event.target.value.toLowerCase().trim();
                if (query.length > 0) {
                    showSuggestions(type, query);
                }
            });
        }
    };

    setupSearchInput('series');
    setupSearchInput('movies');
    setupSearchInput('home');

    let scrollTimer;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
            saveScrollPosition();
        }, 200);
    });

    window.addEventListener('beforeunload', saveScrollPosition);
});
</script>
</body>
</html>
